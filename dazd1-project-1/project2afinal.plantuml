@startuml DonkeyKong Project 2A

/' 必要的格式设置 '/
skinparam linetype ortho
skinparam classAttributeIconSize 0
skinparam abstractClassFontStyle italic
hide circle
scale max 800*1130

/' ========= 1. 实体层次结构 ========= '/

abstract class Entity {
  # x: double
  # y: double
  # image: Image
  + {abstract} draw(): void
  + {abstract} update(): void
  + {abstract} getBoundingBox(): Rectangle
}

class Player extends Entity {
  - RIGHT_IMAGE: Image {static}
  - LEFT_IMAGE: Image {static}
  - HAMMER_RIGHT_IMAGE: Image {static}
  - HAMMER_LEFT_IMAGE: Image {static}
  - BLASTER_RIGHT_IMAGE: Image {static}
  - BLASTER_LEFT_IMAGE: Image {static}
  - MOVE_SPEED: double = 3.5 {static}
  - CLIMB_SPEED: double = 2.0 {static}
  - GRAVITY: double = 0.2 {static}
  - TERMINAL_VELOCITY: double = 10.0 {static}
  - facingRight: boolean = true
  - onGround: boolean = false
  - onLadder: boolean = false
  - verticalVelocity: double = 0
  - hasHammer: boolean = false
  - hasBlaster: boolean = false
  - bulletCount: int = 0
  - previousY: double
  + update(): void
  + draw(): void
  + handleInput(input: Input, windowWidth: int, windowHeight: int): void
  + startClimbing(ladder: Ladder): void
  + stopClimbing(): void
  + collectHammer(): void
  + collectBlaster(): void
  + fireBullet(): Bullet
  + decreaseBullet(): void
  + getBoundingBox(): Rectangle
}

class DonkeyKong extends Entity {
  - DONKEY_KONG_IMAGE: Image {static}
  - GRAVITY: double = 0.2 {static}
  - TERMINAL_VELOCITY: double = 5.0 {static}
  - verticalVelocity: double = 0
  - onGround: boolean = false
  - health: int = 5
  - MAX_HEALTH: int = 5 {static}
  + update(): void
  + draw(): void
  + takeDamage(): void
  + getBoundingBox(): Rectangle
}

abstract class Monkey extends Entity {
  - MONKEY_LEFT_IMAGE: Image {static}
  - MONKEY_RIGHT_IMAGE: Image {static}
  - GRAVITY: double = 0.4 {static}
  - TERMINAL_VELOCITY: double = 5.0 {static}
  - moveSpeed: double = 0.5
  - direction: int
  - verticalVelocity: double = 0
  - onGround: boolean = false
  - patrolRoute: List<Integer>
  - currentRouteIndex: int = 0
  - currentDistance: double = 0
  + {abstract} update(): void
  + draw(): void
  # {abstract} patrol(): void
  + getBoundingBox(): Rectangle
}

class NormalMonkey extends Monkey {
  - NORMAL_MONKEY_LEFT_IMAGE: Image {static}
  - NORMAL_MONKEY_RIGHT_IMAGE: Image {static}
  + update(): void
  # patrol(): void
}

class IntelligentMonkey extends Monkey {
  - INTELLIGENT_MONKEY_LEFT_IMAGE: Image {static}
  - INTELLIGENT_MONKEY_RIGHT_IMAGE: Image {static}
  - lastBananaTime: long = 0
  - BANANA_INTERVAL: long = 5000 {static}
  + update(): void
  + throwBanana(): Banana
  - canThrowBanana(): boolean
  # patrol(): void
}

abstract class Projectile extends Entity {
  - direction: int
  - distanceTraveled: double = 0
  - MAX_DISTANCE: double = 300 {static}
  + {abstract} update(): void
  + draw(): void
  + isOutOfRange(): boolean
  + getBoundingBox(): Rectangle
}

class Bullet extends Projectile {
  - BULLET_LEFT_IMAGE: Image {static}
  - BULLET_RIGHT_IMAGE: Image {static}
  - BULLET_SPEED: double = 3.8 {static}
  + update(): void
}

class Banana extends Projectile {
  - BANANA_IMAGE: Image {static}
  - BANANA_SPEED: double = 1.8 {static}
  + update(): void
}

class Platform extends Entity {
  - PLATFORM_IMAGE: Image {static}
  - COLLISION_TOLERANCE: double = 5.0 {static}
  + update(): void
  + draw(): void
  + isCollidingFromTop(entity: Entity): boolean
  + isWithinHorizontalBounds(entity: Entity): boolean
  + overlaps(entity: Entity): boolean
  + placeEntityOnTop(entity: Entity): void
  + getBoundingBox(): Rectangle
}

class Ladder extends Entity {
  - LADDER_IMAGE: Image {static}
  - GRAVITY: double = 0.25 {static}
  - TERMINAL_VELOCITY: double = 5.0 {static}
  - verticalVelocity: double = 0
  - onGround: boolean = false
  + update(): void
  + draw(): void
  + canPlayerClimb(player: Player): boolean
  + isPlayerAtTopOfLadder(player: Player): boolean
  + isPlayerAtBottomOfLadder(player: Player): boolean
  + getBoundingBox(): Rectangle
}

class Barrel extends Entity {
  - BARREL_IMAGE: Image {static}
  - GRAVITY: double = 0.2 {static}
  - TERMINAL_VELOCITY: double = 5.0 {static}
  - verticalVelocity: double = 0
  - onGround: boolean = false
  - destroyed: boolean = false
  + update(): void
  + draw(): void
  + destroy(): void
  + getBoundingBox(): Rectangle
}

class Hammer extends Entity {
  - HAMMER_IMAGE: Image {static}
  - collected: boolean = false
  + update(): void
  + draw(): void
  + collect(): void
  + getBoundingBox(): Rectangle
}

class Blaster extends Entity {
  - BLASTER_IMAGE: Image {static}
  - collected: boolean = false
  - bulletCount: int = 5
  - MAX_BULLETS: int = 5 {static}
  + update(): void
  + draw(): void
  + collect(): void
  + decreaseBullet(): void
  + isBulletAvailable(): boolean
  + getBoundingBox(): Rectangle
}

/' ========= 2. 屏幕管理类 ========= '/

interface "<<Interface>> Screen" as Screen {
  + update(input: Input): GameState
  + draw(): void
}

class TitleScreen implements Screen {
  - TITLE: String
  - START_PROMPT: String
  - titleFont: Font
  - promptFont: Font
  - titleX: int
  - titleY: int
  - promptY: int
  - windowWidth: int
  - backgroundImage: Image
  + update(input: Input): GameState
  + draw(): void
}

abstract class GameplayScreen implements Screen {
  # windowWidth: int
  # windowHeight: int
  # scoreFont: Font
  # scoreX: int
  # scoreY: int
  # timeY: int
  # currentFrame: int = 0
  # maxFrames: int
  # backgroundImage: Image
  # levelNumber: int
  + {abstract} update(input: Input): GameState
  + {abstract} draw(): void
  # {abstract} loadEntities(): void
  # {abstract} checkLevelCompletion(): GameState
  # {abstract} checkPlatformCollisions(): void
  # {abstract} checkLadderPlatformCollisions(): void
  # {abstract} checkPlayerLadderInteractions(input: Input): void
  # {abstract} checkDonkeyKongPlatformCollisions(): void
}

class Level1Screen extends GameplayScreen {
  - JUMP_COOLDOWN: int = 30 {static}
  + update(input: Input): GameState
  + draw(): void
  - initializeBarrels(props: Properties): void
  - initializeHammer(props: Properties): void
  - checkBarrelPlatformCollisions(): void
  - checkBarrelJumps(): void
  - checkHammerCollision(): void
  - checkPlayerCollisions(): GameState
  # loadEntities(): void
  # checkLevelCompletion(): GameState
  # checkPlatformCollisions(): void
  # checkLadderPlatformCollisions(): void
  # checkPlayerLadderInteractions(input: Input): void
  # checkDonkeyKongPlatformCollisions(): void
}

class BarrelJumpInfo {
  ~ isAboveBarrel: boolean = false
  ~ hasJumpedOver: boolean = false
  ~ cooldownTimer: int = 0
  ~ lastPlayerY: double = 0
  ~ side: int = 0
}

class Level2Screen extends GameplayScreen {
  + update(input: Input): GameState
  + draw(): void
  - initializeMonkeys(props: Properties): void
  - initializeBlaster(props: Properties): void
  - handleShooting(input: Input): void
  - updateBullets(): void
  - updateBananas(): void
  - checkMonkeyPlatformCollisions(): void
  - checkMonkeyCollisions(): GameState
  - checkBulletCollisions(): void
  - checkBananaCollisions(): void
  - checkBlasterCollision(): void
  # loadEntities(): void
  # checkLevelCompletion(): GameState
  # checkPlatformCollisions(): void
  # checkLadderPlatformCollisions(): void
  # checkPlayerLadderInteractions(input: Input): void
  # checkDonkeyKongPlatformCollisions(): void
}

class GameOverScreen implements Screen {
  - statusFont: Font
  - scoreFont: Font
  - statusY: int
  - scoreY: int
  - winMessage: String
  - loseMessage: String
  - continueMessage: String
  - continueY: int
  - result: GameState
  - finalScore: int
  - backgroundImage: Image
  - messageProps: Properties
  + update(input: Input): GameState
  + draw(): void
}

/' ========= 3. 游戏管理类 ========= '/

enum "<<enumeration>> GameState" as GameState {
  TITLE
  LEVEL1
  LEVEL2
  GAME_OVER_WIN
  GAME_OVER_LOSE
}

class ScoreManager {
  - SCORE_X: double = 100 {static}
  - SCORE_Y: double = 100 {static}
  - BARREL_JUMP_SCORE: int = 30 {static}
  - BARREL_DESTROY_SCORE: int = 100 {static}
  - MONKEY_DESTROY_SCORE: int = 100 {static}
  - TIME_BONUS_MULTIPLIER: int = 3 {static}
  - score: int = 0
  - scoreFont: Font
  - timeBonus: boolean = false
  - timeBonusScore: int = 0
  + addScore(points: int): void
  + addTimeBonus(remainingSeconds: int): void
  + draw(): void
  + reset(): void
  + persistScore(): int
  + loadSavedScore(score: int): void
}

class LevelManager {
  - currentLevel: int = 1
  - maxLevels: int = 2
  + advanceToNextLevel(): boolean
  + isLastLevel(): boolean
}

class IOUtils {
  + readPropertiesFile(configFile: String): Properties {static}
}

class ShadowDonkeyKong {
  - GAME_PROPS: Properties
  - MESSAGE_PROPS: Properties
  - currentState: GameState
  - levelManager: LevelManager
  - titleScreen: TitleScreen
  - level1Screen: Level1Screen
  - level2Screen: Level2Screen
  - activeScreen: Screen
  + update(input: Input): void
  - handleStateTransition(newState: GameState): void
  + main(args: String[]): void {static}
}

/' ========= 5. 关系定义 ========= '/

/' 游戏实体间关系 '/
Player "1" -- "1" Platform : "stands on/supports"
Player "1" -- "0..1" Ladder : "climbs/is climbed by"
Player "1" --> "0..1" Hammer : "collects"
Player "1" --> "0..1" Blaster : "collects"
Player "1" -- "0..1" Barrel : "interacts with" 
Player "1" -- "0..1" DonkeyKong : "interacts with"
Player "1" --> "0..1" Bullet : "fires"
Player "1" -- "0..*" Banana : "avoids"
Player "1" -- "0..*" Monkey : "avoids"

Platform "1" -- "0..1" Player : "stands on/supports"
Platform "1" -- "0..5" Ladder : "connects to/supports"
Platform "1" -- "0..5" Barrel : "supports"
Platform "1" -- "0..1" DonkeyKong : "supports"
Platform "1" -- "0..*" Monkey : "supports"

IntelligentMonkey "1" --> "0..*" Banana : "throws"

Banana "0..*" --> "0..1" Player : "damages"
Blaster "1" --> "0..5" Bullet : "provides"

Bullet "0..5" --> "0..1" DonkeyKong : "damages"
Bullet "0..1" --> "0..1" Monkey : "destroys"
Bullet "0..*" --> "0..1" Platform : "destroys"


/' 游戏屏幕关系 '/
GameplayScreen "1" --> "1" Player : "manages"
GameplayScreen "1" --> "6" Platform : "contains"
GameplayScreen "1" --> "5" Ladder : "contains"
GameplayScreen "1" --> "1" DonkeyKong : "manages"
GameplayScreen "1" --> "1" ScoreManager : "uses"

Level1Screen "1" --> "5" Barrel : "contains"
Level1Screen "1" --> "1" Hammer : "manages"
Level1Screen "1" --> "0..5" BarrelJumpInfo : "creates"

Level2Screen "1" --> "1..*" NormalMonkey : "contains"
Level2Screen "1" --> "1..*" IntelligentMonkey : "contains" 
Level2Screen "1" --> "1" Blaster : "manages"
Level2Screen "1" --> "0..*" Bullet : "tracks"
Level2Screen "1" --> "0..*" Banana : "tracks"
Level2Screen "1" --> "1" DonkeyKong : "monitors health"

ShadowDonkeyKong "1" --> "1" LevelManager : "uses"
ShadowDonkeyKong "1" --> "1" TitleScreen : "manages"
ShadowDonkeyKong "1" --> "1" Level1Screen : "manages"
ShadowDonkeyKong "1" --> "1" Level2Screen : "manages"
ShadowDonkeyKong "1" --> "1" Screen : "controls"
ShadowDonkeyKong "1" --> "1" GameState : "tracks"

GameOverScreen "1" --> "1" GameState : "references"

@enduml









